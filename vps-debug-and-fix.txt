# VPS DEBUG AND FIX COMMANDS
# Run these commands one by one to debug and fix the 500 errors

# 1. Check backend logs to see the exact error
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "pm2 logs bulk-messaging-backend --lines 20"

# 2. Test the failing endpoints directly to see error details
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "curl -v 'http://localhost:8080/api/campaigns/logs?limit=5'"

ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "curl -v 'http://localhost:8080/api/devices/health-summary'"

# 3. Check if database tables exist
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "mysql -u root -pWhatsApp@2025! -e 'USE bulk_whatsapp_sms; SHOW TABLES;'"

# 4. Check specific table structures that are causing issues
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "mysql -u root -pWhatsApp@2025! -e 'USE bulk_whatsapp_sms; DESCRIBE device_logs;'"

ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "mysql -u root -pWhatsApp@2025! -e 'USE bulk_whatsapp_sms; DESCRIBE campaigns;'"

ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "mysql -u root -pWhatsApp@2025! -e 'USE bulk_whatsapp_sms; DESCRIBE devices;'"

# 5. If tables don't exist or have wrong structure, recreate them
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "mysql -u root -pWhatsApp@2025! << 'EOF'
DROP DATABASE IF EXISTS bulk_whatsapp_sms;
CREATE DATABASE bulk_whatsapp_sms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE bulk_whatsapp_sms;

-- Users table
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  company_name VARCHAR(255),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Devices table
CREATE TABLE devices (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  device_label VARCHAR(100) NOT NULL,
  phone_number VARCHAR(20),
  device_ip VARCHAR(45),
  device_token VARCHAR(255) UNIQUE NOT NULL,
  is_online BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  warmup_stage ENUM('STAGE_1', 'STAGE_2', 'STAGE_3', 'STAGE_4') DEFAULT 'STAGE_1',
  warmup_started_at DATE,
  messages_sent_today INT DEFAULT 0,
  daily_limit INT DEFAULT 15,
  battery_level INT,
  network_type VARCHAR(50),
  android_version VARCHAR(50),
  app_version VARCHAR(50),
  last_seen TIMESTAMP,
  last_message_sent_at TIMESTAMP,
  total_messages_sent INT DEFAULT 0,
  total_messages_failed INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Excel records table
CREATE TABLE excel_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  filename VARCHAR(255),
  original_name VARCHAR(255),
  file_path VARCHAR(1000) NOT NULL,
  file_size INT DEFAULT 0,
  total_records INT DEFAULT 0,
  processed_records INT DEFAULT 0,
  status VARCHAR(50),
  user_id INT NOT NULL,
  has_duration_column BOOLEAN DEFAULT FALSE,
  has_message_column BOOLEAN DEFAULT FALSE,
  default_duration INT DEFAULT 30,
  default_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Excel rows table
CREATE TABLE excel_rows (
  id INT PRIMARY KEY AUTO_INCREMENT,
  excel_record_id INT NOT NULL,
  phone_number VARCHAR(20) NOT NULL,
  duration INT DEFAULT 30,
  message TEXT,
  status ENUM('PENDING', 'SENT', 'FAILED', 'SKIPPED') DEFAULT 'PENDING',
  sent_at TIMESTAMP,
  error_message TEXT,
  device_id INT,
  row_number INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (excel_record_id) REFERENCES excel_records(id) ON DELETE CASCADE,
  FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE SET NULL
);

-- Campaigns table
CREATE TABLE campaigns (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  excel_record_id INT,
  campaign_type ENUM('STANDARD', 'SCHEDULED', 'RECURRING') DEFAULT 'STANDARD',
  status ENUM('DRAFT', 'PENDING', 'RUNNING', 'COMPLETED', 'PAUSED', 'CANCELLED') DEFAULT 'DRAFT',
  message_content TEXT NOT NULL,
  total_contacts INT DEFAULT 0,
  sent_count INT DEFAULT 0,
  failed_count INT DEFAULT 0,
  pending_count INT DEFAULT 0,
  rotation_mode ENUM('RANDOM', 'ROUND_ROBIN', 'LEAST_USED', 'WARMUP_AWARE') DEFAULT 'WARMUP_AWARE',
  selected_devices JSON,
  scheduled_at TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  priority ENUM('LOW', 'MEDIUM', 'HIGH') DEFAULT 'MEDIUM',
  rate_limit INT DEFAULT 100,
  delay_between_messages INT DEFAULT 1000,
  metadata JSON,
  device_message_distribution JSON,
  timing_config JSON,
  timing_analytics JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (excel_record_id) REFERENCES excel_records(id) ON DELETE SET NULL
);

-- Device logs table
CREATE TABLE device_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  device_id INT NOT NULL,
  campaign_id INT,
  excel_record_id INT,
  excel_row_id INT,
  excel_row_index INT,
  recipient_number VARCHAR(20) NOT NULL,
  message_content TEXT NOT NULL,
  media_url VARCHAR(500),
  status ENUM('QUEUED', 'SENT', 'DELIVERED', 'FAILED', 'PENDING') DEFAULT 'QUEUED',
  error_message TEXT,
  sent_at TIMESTAMP,
  delivered_at TIMESTAMP,
  time_gap_ms INT,
  delivery_time_ms INT,
  device_ip VARCHAR(45),
  network_type VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
  FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE SET NULL,
  FOREIGN KEY (excel_record_id) REFERENCES excel_records(id) ON DELETE SET NULL,
  FOREIGN KEY (excel_row_id) REFERENCES excel_rows(id) ON DELETE SET NULL
);

-- Device commands table
CREATE TABLE device_commands (
  id INT PRIMARY KEY AUTO_INCREMENT,
  device_id INT NOT NULL,
  command_type ENUM('SEND_MESSAGE', 'SEND_MEDIA', 'SYNC_STATUS', 'RESTART', 'UPDATE_CONFIG') NOT NULL,
  payload JSON NOT NULL,
  status ENUM('PENDING', 'SENT', 'ACKNOWLEDGED', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
  priority INT DEFAULT 5,
  sent_at TIMESTAMP,
  completed_at TIMESTAMP,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE
);

-- Device campaigns table
CREATE TABLE device_campaigns (
  id INT PRIMARY KEY AUTO_INCREMENT,
  campaign_id INT NOT NULL,
  device_id INT NOT NULL,
  assigned_message_count INT DEFAULT 0,
  messages_sent_in_campaign INT DEFAULT 0,
  assigned_count INT DEFAULT 0,
  sent_count INT DEFAULT 0,
  failed_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE,
  FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
  UNIQUE KEY unique_campaign_device (campaign_id, device_id)
);

-- Insert test user with proper password hash
INSERT INTO users (email, password, first_name, last_name, company_name) 
VALUES ('testuser@test.com', '$2b$10$rQZ9QmSTnkKzOgWpAuH8eeXCvVRyTQy.Qg9YvJ8vJ8vJ8vJ8vJ8vJ8', 'Test', 'User', 'Test Company');

SHOW TABLES;
EOF"

# 6. Restart backend after database recreation
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "pm2 restart bulk-messaging-backend"

# 7. Test the endpoints again
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "curl 'http://localhost:8080/api/campaigns/logs?limit=5'"

ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "curl 'http://localhost:8080/api/devices/health-summary'"

# 8. Test database connection from Node.js
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa root@66.116.196.226 "cd /var/www/whatsapp-pro/Bulk_whatsapp_message/backend && node -e 'const { sequelize } = require(\"./src/models\"); sequelize.authenticate().then(() => console.log(\"✓ Database connected\")).catch(err => console.log(\"✗ Database error:\", err.message));'"

# 9. Final test
echo "After running these commands, test:"
echo "- https://wxon.in (should load without errors)"
echo "- Login should work"
echo "- Dashboard should load without 500 errors"
echo "- Create Campaign should work"